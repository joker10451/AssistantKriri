require('dotenv').config();
const TelegramBot = require('node-telegram-bot-api');
const AIService = require('./src/services/aiService');

// Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ±Ğ¾Ñ‚Ğ° Ñ polling Ğ´Ğ»Ñ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ñ‚ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
const bot = new TelegramBot(process.env.TELEGRAM_BOT_TOKEN, { polling: true });
const aiService = new AIService();

console.log('ğŸ¤– Test bot started with polling...');

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /start
bot.onText(/\/start/, async (msg) => {
  const chatId = msg.chat.id;
  await bot.sendMessage(chatId, 'ğŸ‘‹ ĞŸÑ€Ğ¸Ğ²ĞµÑ‚! Ğ¯ Ğ²Ğ°Ñˆ Ğ˜Ğ˜-Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚. Ğ—Ğ°Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ¼Ğ½Ğµ Ğ»ÑĞ±Ğ¾Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ!');
});

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /help
bot.onText(/\/help/, async (msg) => {
  const chatId = msg.chat.id;
  const helpText = `ğŸ“‹ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:
/start - Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ±Ğ¾Ñ‚Ğ°
/help - Ğ¡Ğ¿Ñ€Ğ°Ğ²ĞºĞ°
/status - Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ±Ğ¾Ñ‚Ğ°

ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸Ñ‚Ğµ Ğ¼Ğ½Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ, Ğ¸ Ñ Ğ¾Ñ‚Ğ²ĞµÑ‡Ñƒ!`;
  await bot.sendMessage(chatId, helpText);
});

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ /status
bot.onText(/\/status/, async (msg) => {
  const chatId = msg.chat.id;
  try {
    const aiStatus = aiService.getStatus();
    const aiAvailable = await aiService.isAvailable();
    
    const statusMessage = `ğŸ¤– Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ±Ğ¾Ñ‚Ğ°

ğŸ§  Ğ˜Ğ˜ Ğ¡ĞµÑ€Ğ²Ğ¸Ñ: ${aiAvailable ? 'âœ… Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½' : 'âŒ ĞĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½'}
ğŸ”§ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ: ${aiStatus.initialized ? 'âœ… OK' : 'âŒ ĞÑˆĞ¸Ğ±ĞºĞ°'}
ğŸ”‘ API ĞšĞ»ÑÑ‡: ${aiStatus.hasApiKey ? 'âœ… ĞĞ°ÑÑ‚Ñ€Ğ¾ĞµĞ½' : 'âŒ ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚'}
ğŸ¤– ĞœĞ¾Ğ´ĞµĞ»ÑŒ: ${aiStatus.model}

â° Ğ’Ñ€ĞµĞ¼Ñ: ${new Date().toLocaleString('ru-RU')}`;

    await bot.sendMessage(chatId, statusMessage);
  } catch (error) {
    console.error('âŒ Error getting status:', error);
    await bot.sendMessage(chatId, 'âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ±Ğ¾Ñ‚Ğ°.');
  }
});

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
bot.on('message', async (msg) => {
  const chatId = msg.chat.id;
  const text = msg.text;
  
  // ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹
  if (text && text.startsWith('/')) {
    return;
  }
  
  if (!text) {
    await bot.sendMessage(chatId, 'ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ÑŒÑ‚Ğµ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ.');
    return;
  }
  
  try {
    console.log('ğŸ’¬ Received message:', text.substring(0, 50) + '...');
    
    // ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€ "Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ°ĞµÑ‚"
    await bot.sendChatAction(chatId, 'typing');
    
    // Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ Ğ˜Ğ˜
    const aiResponse = await aiService.generateResponse(text);
    
    // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚
    await bot.sendMessage(chatId, aiResponse);
    
    console.log('âœ… Response sent successfully');
    
  } catch (error) {
    console.error('âŒ Error handling message:', error);
    
    // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ fallback ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
    const fallbackMessage = aiService.getFallbackMessage(error.message);
    await bot.sendMessage(chatId, fallbackMessage);
  }
});

// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
bot.on('error', (error) => {
  console.error('âŒ Bot error:', error);
});

bot.on('polling_error', (error) => {
  console.error('âŒ Polling error:', error);
});

console.log('ğŸš€ Bot is ready! Send /start to begin.');
console.log('ğŸ“± Go to Telegram and find your bot to test it.');